<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Dashboard - Genius Academy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <!-- Firebase SDK (compat for browser) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- jsPDF for certificate generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{ --accent-teal:#00BFA5; --primary-blue:#0A3D62 }
    body{ font-family:'Inter',sans-serif }
    .progress-ring { transform: rotate(-90deg); }
    .badge { transition: transform 0.2s; }
    .badge:hover { transform: scale(1.1); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Firebase config + Guard -->
  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/database.js"></script>
  <script src="js/guard.js"></script>
  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="js/email-service.js"></script>

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center text-xl font-extrabold text-blue-800 tracking-tight">
        <i class="fas fa-brain text-2xl mr-2 text-[var(--accent-teal)]"></i> Genius Academy
      </a>
      <nav class="flex items-center gap-6 text-sm font-medium">
        <a href="index.html" class="text-gray-600 hover:text-[var(--accent-teal)]">Home</a>
        <a href="courses-access.html" class="text-gray-600 hover:text-[var(--accent-teal)]">My Courses</a>
        <button onclick="handleLogout()" class="text-gray-600 hover:text-[var(--accent-teal)]">
          <i class="fas fa-sign-out-alt mr-1"></i> Logout
        </button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Welcome Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back, <span id="userName">Student</span>!</h1>
      <p class="text-gray-600">Track your progress and manage your learning journey.</p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-6 border-l-4 border-[var(--accent-teal)]">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Courses Enrolled</p>
            <p class="text-3xl font-bold text-gray-900" id="enrolledCount">0</p>
          </div>
          <i class="fas fa-book text-3xl text-[var(--accent-teal)]"></i>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border-l-4 border-blue-600">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Lessons Completed</p>
            <p class="text-3xl font-bold text-gray-900" id="lessonsComplete">0</p>
          </div>
          <i class="fas fa-check-circle text-3xl text-blue-600"></i>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border-l-4 border-purple-600">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Progress</p>
            <p class="text-3xl font-bold text-gray-900"><span id="avgProgress">0</span>%</p>
          </div>
          <i class="fas fa-chart-line text-3xl text-purple-600"></i>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Certificates Earned</p>
            <p class="text-3xl font-bold text-gray-900" id="certCount">0</p>
          </div>
          <i class="fas fa-certificate text-3xl text-yellow-500"></i>
        </div>
      </div>
    </div>

    <!-- Achievement Badges -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-trophy text-yellow-500"></i> Achievement Badges
      </h2>
      <div id="badgesContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <!-- Badges will be dynamically inserted -->
      </div>
    </div>

    <!-- Enrolled Courses -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-graduation-cap text-[var(--accent-teal)]"></i> My Courses
      </h2>
      <div id="coursesContainer" class="space-y-4">
        <!-- Courses will be dynamically inserted -->
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
          <p>Loading your courses...</p>
        </div>
      </div>
    </div>

    <!-- Account Settings -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-cog text-gray-600"></i> Account Settings
      </h2>
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Profile Info -->
        <div>
          <h3 class="font-semibold mb-3 text-gray-900">Profile Information</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
              <input type="text" id="displayName" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Your Name" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="userEmail" disabled class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50" />
            </div>
            <button onclick="updateProfile()" class="px-4 py-2 bg-[var(--accent-teal)] hover:bg-teal-600 text-white font-semibold rounded-lg transition">
              <i class="fas fa-save mr-2"></i>Save Changes
            </button>
          </div>
        </div>

        <!-- Password Change -->
        <div>
          <h3 class="font-semibold mb-3 text-gray-900">Change Password</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
              <input type="password" id="newPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Min. 6 characters" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
              <input type="password" id="confirmPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Re-enter password" />
            </div>
            <button onclick="changePassword()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
              <i class="fas fa-key mr-2"></i>Update Password
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white text-center text-sm py-6 mt-8">
    &copy; 2025 Genius Academy. All rights reserved.
  </footer>

  <script>
    let currentUser = null;
    let userEnrollments = [];

    // Badge definitions
    const badges = [
      { id: 'first-lesson', name: 'First Steps', icon: 'fa-star', color: 'text-yellow-500', condition: (data) => data.totalLessons >= 1 },
      { id: 'week-streak', name: '7 Day Streak', icon: 'fa-fire', color: 'text-orange-500', condition: (data) => data.daysActive >= 7 },
      { id: 'half-way', name: 'Half Way There', icon: 'fa-flag', color: 'text-blue-500', condition: (data) => data.avgProgress >= 50 },
      { id: 'course-complete', name: 'Course Master', icon: 'fa-trophy', color: 'text-purple-500', condition: (data) => data.coursesCompleted >= 1 },
      { id: 'speed-learner', name: 'Speed Learner', icon: 'fa-bolt', color: 'text-yellow-400', condition: (data) => data.totalLessons >= 10 },
      { id: 'perfectionist', name: 'Perfectionist', icon: 'fa-certificate', color: 'text-green-500', condition: (data) => data.avgProgress === 100 },
    ];

    // Load user data
    onAuthChange(async (user) => {
      if (!user) return;
      
      currentUser = user;
      document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
      document.getElementById('userEmail').value = user.email;
      document.getElementById('displayName').value = user.displayName || '';

      await loadDashboardData();
    });

    async function loadDashboardData() {
      try {
        // Get all user enrollments
        const enrollmentsSnap = await db.collection('enrollments')
          .where('userId', '==', currentUser.uid)
          .get();

        userEnrollments = [];
        let totalProgress = 0;
        let totalLessons = 0;
        let completedCourses = 0;

        enrollmentsSnap.forEach(doc => {
          const data = doc.data();
          userEnrollments.push({ id: doc.id, ...data });
          totalProgress += data.progress || 0;
          totalLessons += (data.completedLessons || []).length;
          if (data.progress === 100) completedCourses++;
        });

        // Update stats
        document.getElementById('enrolledCount').textContent = userEnrollments.length;
        document.getElementById('lessonsComplete').textContent = totalLessons;
        document.getElementById('avgProgress').textContent = userEnrollments.length > 0 
          ? Math.round(totalProgress / userEnrollments.length) 
          : 0;
        document.getElementById('certCount').textContent = completedCourses;

        // Render badges
        renderBadges({ totalLessons, avgProgress: totalProgress / userEnrollments.length, coursesCompleted: completedCourses, daysActive: 7 });

        // Render courses
        renderCourses();
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    function renderBadges(userData) {
      const container = document.getElementById('badgesContainer');
      container.innerHTML = badges.map(badge => {
        const earned = badge.condition(userData);
        return `
          <div class="badge flex flex-col items-center p-4 rounded-lg ${earned ? 'bg-gray-50 border-2 border-' + badge.color.replace('text-', '') : 'bg-gray-100 opacity-40'}">
            <i class="fas ${badge.icon} text-4xl ${earned ? badge.color : 'text-gray-400'} mb-2"></i>
            <p class="text-xs font-semibold text-center ${earned ? 'text-gray-900' : 'text-gray-500'}">${badge.name}</p>
            ${earned ? '<span class="text-xs text-green-600 mt-1">âœ“ Earned</span>' : '<span class="text-xs text-gray-400 mt-1">Locked</span>'}
          </div>
        `;
      }).join('');
    }

    function renderCourses() {
      const container = document.getElementById('coursesContainer');
      
      if (userEnrollments.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-book text-5xl text-gray-300 mb-3"></i>
            <p class="text-gray-600">You haven't enrolled in any courses yet.</p>
            <a href="index.html#featured" class="inline-block mt-4 px-6 py-2 bg-[var(--accent-teal)] hover:bg-teal-600 text-white font-semibold rounded-lg transition">
              Browse Courses
            </a>
          </div>
        `;
        return;
      }

      container.innerHTML = userEnrollments.map(enrollment => {
        const progress = enrollment.progress || 0;
        const isComplete = progress === 100;
        const courseName = enrollment.courseId === 'prompt-engineering' 
          ? 'The Genius of the Prompt' 
          : enrollment.courseId;

        return `
          <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
            <div class="flex-1">
              <h3 class="font-semibold text-lg text-gray-900">${courseName}</h3>
              <div class="flex items-center gap-4 mt-2">
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                  <div class="bg-[var(--accent-teal)] h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
                <span class="text-sm font-semibold text-gray-700">${progress}%</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                ${(enrollment.completedLessons || []).length} lessons completed
                ${enrollment.lastAccessedDate ? ' â€¢ Last accessed ' + new Date(enrollment.lastAccessedDate.seconds * 1000).toLocaleDateString() : ''}
              </p>
            </div>
            <div class="flex items-center gap-2 ml-4">
              ${isComplete ? `
                <button onclick="downloadCertificate('${enrollment.courseId}')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition text-sm">
                  <i class="fas fa-certificate mr-1"></i> Certificate
                </button>
              ` : ''}
              <a href="access.html" class="px-4 py-2 bg-[var(--accent-teal)] hover:bg-teal-600 text-white font-semibold rounded-lg transition text-sm">
                ${isComplete ? 'Review' : 'Continue'}
              </a>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update profile
    window.updateProfile = async function() {
      const newDisplayName = document.getElementById('displayName').value.trim();
      if (!newDisplayName) {
        alert('Please enter a display name');
        return;
      }

      try {
        await currentUser.updateProfile({ displayName: newDisplayName });
        await db.collection('users').doc(currentUser.uid).update({ displayName: newDisplayName });
        alert('Profile updated successfully!');
        document.getElementById('userName').textContent = newDisplayName;
      } catch (error) {
        alert('Error updating profile: ' + error.message);
      }
    }

    // Change password
    window.changePassword = async function() {
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;

      if (newPass.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }

      if (newPass !== confirmPass) {
        alert('Passwords do not match');
        return;
      }

      try {
        await currentUser.updatePassword(newPass);
        alert('Password updated successfully!');
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          alert('Please log out and log back in before changing your password.');
        } else {
          alert('Error updating password: ' + error.message);
        }
      }
    }

    // Download certificate
    window.downloadCertificate = async function(courseId) {
      const { jsPDF } = window.jspdf;
      
      // Get enrollment data for completion date
      const enrollmentDoc = await db.collection('enrollments')
        .where('userId', '==', currentUser.uid)
        .where('courseId', '==', courseId)
        .get();
      
      let completionDate = new Date();
      if (!enrollmentDoc.empty) {
        const data = enrollmentDoc.docs[0].data();
        completionDate = data.completedDate ? new Date(data.completedDate.seconds * 1000) : new Date();
      }

      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      // Certificate design - Enhanced professional look
      doc.setFillColor(10, 61, 98);
      doc.rect(0, 0, 297, 210, 'F');

      doc.setFillColor(255, 255, 255);
      doc.rect(15, 15, 267, 180, 'F');

      doc.setFillColor(0, 191, 165);
      doc.rect(15, 15, 267, 20, 'F');

      // Add decorative borders
      doc.setDrawColor(0, 191, 165);
      doc.setLineWidth(2);
      doc.rect(20, 40, 257, 150);

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(24);
      doc.setFont(undefined, 'bold');
      doc.text('CERTIFICATE OF COMPLETION', 148.5, 27, { align: 'center' });

      // Genius Academy branding
      doc.setTextColor(0, 191, 165);
      doc.setFontSize(18);
      doc.text('ðŸ§  Genius Academy', 148.5, 55, { align: 'center' });

      doc.setTextColor(51, 51, 51);
      doc.setFontSize(14);
      doc.setFont(undefined, 'normal');
      doc.text('This certifies that', 148.5, 70, { align: 'center' });

      doc.setFontSize(32);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(10, 61, 98);
      doc.text(currentUser.displayName || currentUser.email, 148.5, 90, { align: 'center' });

      doc.setTextColor(51, 51, 51);
      doc.setFontSize(14);
      doc.setFont(undefined, 'normal');
      doc.text('has successfully completed the course', 148.5, 105, { align: 'center' });

      doc.setFontSize(22);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 191, 165);
      doc.text('The Genius of the Prompt', 148.5, 122, { align: 'center' });

      doc.setTextColor(51, 51, 51);
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text('Mastering AI Communication for Expert-Level Output', 148.5, 132, { align: 'center' });

      // Certificate ID for verification
      const certId = `GA-${currentUser.uid.substring(0, 8).toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;
      doc.setFontSize(9);
      doc.text('Certificate ID: ' + certId, 148.5, 145, { align: 'center' });

      doc.setFontSize(11);
      doc.text('Completion Date: ' + completionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 148.5, 155, { align: 'center' });

      // Signature line
      doc.setDrawColor(0, 191, 165);
      doc.setLineWidth(0.5);
      doc.line(110, 170, 160, 170);
      doc.setFontSize(10);
      doc.text('Authorized Signature', 135, 177, { align: 'center' });

      // Footer
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text('Verify at: geniusacademy.com/verify/' + certId, 148.5, 188, { align: 'center' });

      // Save certificate
      const fileName = `Genius-Academy-Certificate-${courseId}-${completionDate.getFullYear()}.pdf`;
      doc.save(fileName);

      // Store certificate data in Firestore for verification
      try {
        await db.collection('certificates').add({
          userId: currentUser.uid,
          courseId: courseId,
          certId: certId,
          userName: currentUser.displayName || currentUser.email,
          completionDate: firebase.firestore.Timestamp.fromDate(completionDate),
          issuedDate: firebase.firestore.Timestamp.now(),
          verified: true
        });
      } catch (error) {
        console.error('Error storing certificate:', error);
      }

      // Show LinkedIn share option
      showLinkedInShareOption(certId);
    }

    // Show LinkedIn share modal
    function showLinkedInShareOption(certId) {
      const courseName = 'The Genius of the Prompt';
      const orgId = ''; // Add your LinkedIn organization ID
      const certUrl = `https://geniusacademy.com/verify/${certId}`;
      
      const linkedInUrl = `https://www.linkedin.com/profile/add?startTask=CERTIFICATION_NAME&name=${encodeURIComponent(courseName)}&organizationId=${orgId}&issueYear=${new Date().getFullYear()}&issueMonth=${new Date().getMonth() + 1}&certUrl=${encodeURIComponent(certUrl)}&certId=${encodeURIComponent(certId)}`;

      if (confirm('Certificate downloaded! Would you like to add this certification to your LinkedIn profile?')) {
        window.open(linkedInUrl, '_blank');
      }
    }

    // Logout
    window.handleLogout = async function() {
      const result = await logOut();
      if (result.success) {
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>

